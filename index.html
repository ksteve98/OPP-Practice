<!doctype html>
<html lang="en">
<head>
   <!-- existing meta, styles, etc. -->

  <!-- Cloudflare Web Analytics -->
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js"
          data-cf-beacon='{"token": "bab954305d3149e099f659a3acfb94d9"}'></script>
  <!-- End Cloudflare Web Analytics -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPP III/IV Technique Practice</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --accent: #0b6ef6;
      --text: #1b1b1f;
      --muted: #6b6b73;
      --border: #dcdce0;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 16px 24px;
      background: #0f172a;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }
    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
    .panel h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }
    .region-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .region-title {
      font-weight: 700;
      font-size: 16px;
    }
    .checkbox-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 6px 12px;
      margin-bottom: 4px;
    }
    label.tech {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s ease;
    }
    label.tech:hover {
      background: #f0f4ff;
    }
    .muted {
      color: var(--muted);
      font-size: 13px;
    }
    .notes-panel {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #f8fafc;
    }
    .notes-panel textarea {
      width: 100%;
      min-height: 100px;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    .note-status {
      font-size: 12px;
      color: var(--muted);
    }
    .badge {
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      color: #0f172a;
      min-width: 38px;
      text-align: center;
      display: inline-block;
    }
    .notes-history {
      margin-top: 8px;
      border-top: 1px solid var(--border);
      padding-top: 8px;
    }
    .notes-history h4 {
      margin: 0 0 6px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
    }
    .notes-history ul {
      margin: 0;
      padding-left: 16px;
      max-height: 140px;
      overflow: auto;
      color: var(--muted);
      font-size: 13px;
    }
    label.tech.disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .rendered-img {
      max-width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .notes-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .notes-table th, .notes-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      vertical-align: top;
    }
    .notes-table th {
      background: #f8fafc;
      font-weight: 700;
    }
    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.1s ease;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 16px rgba(11, 110, 246, 0.25);
    }
    button.secondary {
      background: #e2e8f0;
      color: #0f172a;
    }
    button.ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    button:active { transform: translateY(1px); }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .status-text {
      font-size: 12px;
      color: #e2e8f0;
      opacity: 0.9;
    }
    .hidden { display: none !important; }
    .card {
      padding: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }
    .prompt {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px;
    }
    .pages {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    #rendered-pages {
      display: grid;
      gap: 14px;
      margin-bottom: 12px;
    }
    canvas {
      max-width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .stat-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .stat-table th, .stat-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .stat-table th {
      background: #f8fafc;
      font-weight: 700;
    }
    @media (max-width: 600px) {
      header { flex-direction: column; align-items: flex-start; }
      .checkbox-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    }
  </style>
</head>
<body>
  <header>
    <h1>OPP Technique Practice</h1>
    <div class="actions">
      <input type="file" id="import-data-file" accept="application/json" style="display:none;">
      <button class="secondary" id="export-data-btn">Export Data</button>
      <button class="secondary" id="import-data-btn">Import Data</button>
      <button class="secondary" id="view-stats-btn">View Stats</button>
      <button class="secondary" id="view-notes-btn">View Notes</button>
      <button class="ghost" id="reset-stats-btn">Reset Stats</button>
    </div>
    <div class="status-text" id="data-status"></div>
  </header>
  <main>
    <div id="setup-screen">
      <div class="panel">
        <h2>Select techniques to practice</h2>
        <p class="muted">Choose any mix of regions and techniques. Use “Select all” to grab a whole region.</p>
      </div>
      <div id="regions-container"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="primary" id="start-btn">Start Session</button>
        <button class="ghost" id="clear-btn">Clear Selections</button>
      </div>
    </div>

    <div id="practice-screen" class="hidden">
      <div class="panel">
        <div class="actions" style="justify-content: space-between;">
          <div class="muted" id="session-progress">Card 0 / 0</div>
          <div class="actions">
            <button class="ghost" id="quit-btn">Quit Session</button>
          </div>
        </div>
      </div>
      <div class="card" id="card-container">
        <div class="prompt" id="prompt-text"></div>
        <div class="pages" id="page-info"></div>
        <div class="actions" style="margin-bottom: 10px;">
          <button class="secondary" id="show-manual-btn">Show Manual Page</button>
          <a id="open-pdf-link" class="secondary" style="display:inline-flex; align-items:center; text-decoration:none; padding:10px 14px; border-radius:10px; border:1px solid var(--border);" target="_blank" rel="noopener">Open PDF</a>
        </div>
        <div id="rendered-pages" class="hidden"></div>
        <div class="actions" style="margin-top: 12px;">
          <button class="primary" id="correct-btn">Mark Correct</button>
          <button class="secondary" id="incorrect-btn">Mark Incorrect</button>
          <button class="ghost" id="next-btn">Skip / Next</button>
          <button class="ghost" id="toggle-notes-btn">Notes</button>
        </div>
        <div class="notes-panel hidden" id="notes-panel">
          <div class="muted" style="margin-bottom:6px;">Add personal hints or reminders; saved per technique on this device.</div>
          <textarea id="notes-text"></textarea>
          <div class="note-status" id="note-status"></div>
          <div class="notes-history" id="note-history"></div>
          <div class="actions" style="margin-top:8px;">
            <button class="primary" id="save-notes-btn">Save Note</button>
            <button class="ghost" id="hide-notes-btn">Hide</button>
          </div>
        </div>
      </div>
    </div>

    <div id="stats-screen" class="hidden">
      <div class="panel">
        <h2>Performance by Technique</h2>
        <p class="muted">Counts are stored locally on this device. Reset anytime.</p>
        <div id="stats-table-wrapper"></div>
        <div class="actions" style="margin-top: 10px;">
          <button class="secondary" id="close-stats-btn">Close</button>
        </div>
      </div>
    </div>

    <div id="notes-screen" class="hidden">
      <div class="panel">
        <h2>Saved Notes</h2>
        <p class="muted">Notes are stored locally or via your exported JSON. Click a row to copy the note text.</p>
        <div id="notes-table-wrapper"></div>
        <div class="actions" style="margin-top: 10px;">
          <button class="secondary" id="close-notes-btn">Close</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Data model
    // Keep the PDF in the same folder as this file. Simpler name avoids URL encoding issues.
    const PDF_PATH = 'opp-manual.pdf';
    const DISABLED_KEYWORDS = [
      'psoas major',
      'low ilium',
      'psoas minor',
      'inguinal',
      'pectineus',
      'iliacus',
      'piriformis',
      'upper pole l5',
      'lower pole l5',
      'pl3 lateral',
      'pl4 lateral',
      'gluteus medius',
      'hifo',
      'coccygeus',
      'hisi',
      'ps1 bilateral',
      'ps5 bilateral',
    ];

    const TECHNIQUES = [
      { region: 'Cervical', items: [
        { name: 'BLT/LAS for OA Joint Dysfunctions', pages: [266] },
        { name: 'BLT/LAS for AA Joint Dysfunctions', pages: [267] },
        { name: 'Short-lever BLT/LAS for Typical Cervical (C2-C7) Joint Dysfunctions', pages: [268] },
        { name: 'Long-lever BLT/LAS for Typical Cervical (C2-C7) Joint Dysfunctions', pages: [269] },
        { name: 'FPR for OA Joint Dysfunctions', pages: [270] },
        { name: 'FPR for AA Joint Dysfunctions', pages: [271] },
        { name: 'FPR for Typical Cervical (C2-C7) Joint Dysfunctions', pages: [272] },
        { name: 'Still for OA Joint Dysfunctions', pages: [273] },
        { name: 'Still for AA Joint Dysfunctions', pages: [274] },
        { name: 'Still for Typical Cervical (C2-C7) Joint Dysfunctions', pages: [275] },
      ]},
      { region: 'Thoracic', items: [
        { name: 'Short-lever BLT for Thoracic and Lumbar Joint Dysfunctions', pages: [31] },
        { name: 'Short-lever BLT/LAS for Upper Thoracic (T1-T2) Joint Dysfunctions', pages: [276] },
        { name: 'Long-lever BLT/LAS for Thoracic Joint Dysfunctions', pages: [277] },
        { name: 'FPR for Upper (T1-4) Thoracic Joint Dysfunctions', pages: [278] },
        { name: 'FPR for Lower (T5-T12) Type I Thoracic Joint Dysfunctions', pages: [279] },
        { name: 'FPR for Lower (T5-T12) Type II Thoracic Joint Dysfunctions', pages: [280] },
        { name: 'Seated Still for Upper (T1-4) Thoracic Joint Dysfunctions', pages: [287] },
        { name: 'Seated Still for Lower (T5-12) Type I Thoracic Joint Dysfunctions', pages: [288] },
        { name: 'Seated Still for Lower (T5-12) Type II Thoracic Joint Dysfunctions', pages: [289] },
        { name: 'Seated HVLA for Type II Thoracic Joint Dysfunctions/“Epigastric Thrust”', pages: [281] },
        { name: 'Seated HVLA for Type II Extended Thoracic Joint Dysfunctions/“Knee in Back”', pages: [282, 283] },
        { name: 'Seated HVLA for Type II Flexed Thoracic Joint Dysfunctions/“Knee in Back”', pages: [282, 283] },
        { name: 'Prone HVLA for Lower (T5-T12) Thoracic Joint Dysfunctions/“Texas Twist”', pages: [285] },
      ]},
      { region: 'Lumbar', items: [
        { name: 'Long-lever BLT/LAS for lumbar Joint dysfunctions', pages: [292] },
        { name: 'BLT/LAS for lumbosacral junction', pages: [293] },
        { name: 'FPR for Type I Lumbar Joint Dysfunctions', pages: [294] },
        { name: 'FPR for Type II Lumbar Joint Dysfunctions', pages: [295] },
        { name: 'Supine Still for Type I Lumbar Joint Dysfunctions', pages: [296] },
        { name: 'Supine Still for Type II Flexed Lumbar Joint Dysfunctions', pages: [297] },
        { name: 'Supine Still for Type II Extended Lumbar Joint Dysfunctions', pages: [298] },
      ]},
      { region: 'Pelvic/Sacrum', items: [
        { name: 'Supine BLT/LAS for innominate dysfunctions', pages: [299] },
        { name: 'Seated BLT/LAS for innominate dysfunctions', pages: [300] },
        { name: 'Seated BLT/LAS for pelvic diaphragm', pages: [301] },
        { name: 'Four Pole BLT/LAS for sacrum dysfunctions', pages: [305, 306] },
      ]},
      { region: 'Ribs/Diaphragm', items: [
        { name: 'BLT Respiratory Diaphragm Dysfunctions', pages: [99] },
        { name: 'Posterior Diaphragm BLT/LAS', pages: [30] },
        { name: 'BLT/LAS for Rib Dysfunction', pages: [80] },
        { name: 'Still Technique for Rib 1 Superior/Exhaled', pages: [48] },
        { name: 'Still Technique for Rib 1 Inferior/Inhaled', pages: [49] },
        { name: 'Still Technique for ribs 2-10 Exhaled/Posterior', pages: [68] },
        { name: 'Still Technique for ribs 2-10 Inhaled/Anterior', pages: [69] },
        { name: 'ME for Structural 1st Rib Dysfunction', pages: [82] },
        { name: 'ME for Anterior Rib Subluxation', pages: [83] },
        { name: 'ME for Posterior Rib Subluxation', pages: [84] },
        { name: 'ME for Anterior/Posterior Rib Compression', pages: [85] },
        { name: 'ME for Lateral Rib Compression', pages: [86] },
      ]},
      { region: 'Visceral', items: [
        { name: 'Liver Pump', pages: [106] },
        { name: 'Spleen Pump', pages: [107] },
        { name: 'Colonic Milking', pages: [132] },
        { name: 'Linea Alba Release/Collateral Ganglia Inhibition', pages: [128] },
        { name: 'Sigmoid Colon Release', pages: [129] },
        { name: 'Small Bowel Mesentery Release', pages: [131] },
        { name: 'Liver/Gallbladder Release', pages: [133] },
        { name: 'Direct (Long-lever) Kidney Visceral technique', pages: [34] },
        { name: 'Direct (Short-lever) Kidney Visceral technique', pages: [33] },
      ]},
      { region: 'Lymphatic/Other', items: [
        { name: 'Anterior cervical fascia/hyoid MFR', pages: [63] },
        { name: 'Submandibular MFR', pages: [103] },
        { name: 'Orbital nerve release', pages: [65] },
        { name: 'Facial effleurage', pages: [65] },
        { name: 'Sinus tapping', pages: [65] },
        { name: 'Auricular drainage', pages: [66] },
        { name: 'Galbreath technique', pages: [67] },
        { name: 'Quadratus Lumborum Long-lever Indirect MFR', pages: [32] },
        { name: 'Ischiorectal Fossa Release', pages: [100] },
        { name: 'Thoracic Inlet BLT/LAS/MFR', pages: [62] },
        { name: 'BLT/LAS/MFR for sternum/pericardial ligaments', pages: [29] },
        { name: 'BLT/LAS/MFR for rib cage dysfunctions', pages: [30] },
      ]},
      { region: 'Counterstrain – Cervical', items: [
        { name: 'Counterstrain: Anterior Cervical (AC1 Mandible & AC1 TP)', pages: [316] },
        { name: 'Counterstrain: Anterior Cervical (AC7)', pages: [317] },
        { name: 'Counterstrain: Posterior Cervical (PC2, PC4-8 SP midline)', pages: [318] },
        { name: 'Counterstrain: Posterior Cervical (PC3 SP midline)', pages: [319] },
      ]},
      { region: 'Counterstrain – Thoracic', items: [
        { name: 'Counterstrain: Anterior Thoracic (AT1-6 midline, AT10 example)', pages: [321] },
        { name: 'Counterstrain: Posterior Thoracic (PT1-12 transverse processes)', pages: [322] },
      ]},
      { region: 'Counterstrain – Lumbar', items: [
        { name: 'Counterstrain: Anterior Lumbar (AL1 overview)', pages: [324] },
        { name: 'Counterstrain: Anterior Lumbar (AL5)', pages: [325] },
      ]},
      { region: 'Counterstrain – Pelvis/Sacrum', items: [
        { name: 'Counterstrain: Sacral Region (PS1, PS5)', pages: [326] },
        { name: 'Counterstrain: Anterior Pelvis CPs', pages: [327] },
        { name: 'Counterstrain: Psoas Major', pages: [328] },
        { name: 'Counterstrain: Psoas/Iliacus variation (lateral recumbent)', pages: [329] },
        { name: 'Counterstrain: Posterior Pelvis CPs', pages: [330] },
        { name: 'Counterstrain: Upper Pole L5', pages: [331] },
        { name: 'Counterstrain: High Ilium Sacroiliac (HISI)', pages: [332] },
      ]},
      { region: 'Counterstrain – Ribs', items: [
        { name: 'Counterstrain: Rib Region Overview (AR/PR 1-10 locations)', pages: [343] },
        { name: 'Counterstrain: Anterior Rib (AR) 1-10', pages: [344] },
        { name: 'Counterstrain: Posterior Rib (PR) 1-10', pages: [345] },
      ]},
      { region: 'Counterstrain – Lower Extremity', items: [
        { name: 'Counterstrain: Lower Extremity CP overview', pages: [333] },
        { name: 'Counterstrain: Lateral Trochanter', pages: [334] },
        { name: 'Counterstrain: Medial Hamstring (Semimembranosus)', pages: [335] },
        { name: 'Counterstrain: Medial Ankle (Tibialis Anterior)', pages: [336] },
        { name: 'Counterstrain: Gastrocnemius (Extension ankle)', pages: [337] },
      ]},
      { region: 'Counterstrain – Upper Extremity', items: [
        { name: 'Counterstrain: Upper Extremity CP overview', pages: [338] },
        { name: 'Counterstrain: Subscapularis', pages: [339] },
      ]},
    ];

    const el = (id) => document.getElementById(id);
    const setupScreen = el('setup-screen');
    const practiceScreen = el('practice-screen');
    const statsScreen = el('stats-screen');
    const regionsContainer = el('regions-container');
    const promptText = el('prompt-text');
    const pageInfo = el('page-info');
    const openPdfLink = el('open-pdf-link');
    const sessionProgress = el('session-progress');

    let sessionDeck = [];
    let currentIndex = 0;
    let stats = loadStats();

    // Render region selectors
    TECHNIQUES.forEach((region, regionIdx) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'panel';

      const header = document.createElement('div');
      header.className = 'region-header';

      const title = document.createElement('div');
      title.className = 'region-title';
      title.textContent = region.region;
      header.appendChild(title);

      const selectAllBtn = document.createElement('button');
      selectAllBtn.className = 'secondary';
      selectAllBtn.textContent = 'Select all';
      selectAllBtn.addEventListener('click', () => {
        wrapper.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      });
      header.appendChild(selectAllBtn);
      wrapper.appendChild(header);

      const grid = document.createElement('div');
      grid.className = 'checkbox-grid';
      region.items.forEach((item, idx) => {
        const id = `region-${regionIdx}-item-${idx}`;
        const label = document.createElement('label');
        label.className = 'tech';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.dataset.techName = item.name;
        cb.dataset.region = region.region;
        if (isDisabled(item.name)) {
          cb.disabled = true;
          label.classList.add('disabled');
        }
        const span = document.createElement('span');
        const pct = Math.round(getAccuracy(item.name) * 100);
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.style.background = accuracyColor(pct);
        badge.textContent = `${pct}%`;
        span.textContent = item.name;
        label.append(cb, span, badge);
        grid.appendChild(label);
      });
      wrapper.appendChild(grid);
      regionsContainer.appendChild(wrapper);
    });

    // Event wiring
    el('start-btn').addEventListener('click', startSession);
    el('clear-btn').addEventListener('click', () => {
      regionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });
    const renderedPages = el('rendered-pages');
    const importDataInput = el('import-data-file');
    const exportDataBtn = el('export-data-btn');
    const importDataBtn = el('import-data-btn');
    const dataStatus = el('data-status');
    const viewNotesBtn = el('view-notes-btn');
    const notesScreen = el('notes-screen');
    const closeNotesBtn = el('close-notes-btn');
    const notesPanel = el('notes-panel');
    const notesText = el('notes-text');
    const toggleNotesBtn = el('toggle-notes-btn');
    const saveNotesBtn = el('save-notes-btn');
    const hideNotesBtn = el('hide-notes-btn');
    const noteStatus = el('note-status');
    const noteHistory = el('note-history');
    const showManualBtn = el('show-manual-btn');
    let notes = normalizeNotes(loadNotes());
    let manualVisible = false;
    el('show-manual-btn').addEventListener('click', () => {
      manualVisible = !manualVisible;
      if (manualVisible) {
        renderedPages.classList.remove('hidden');
        showManualBtn.textContent = 'Hide Manual Page';
      } else {
        renderedPages.classList.add('hidden');
        showManualBtn.textContent = 'Show Manual Page';
      }
    });
    el('correct-btn').addEventListener('click', () => gradeCurrent(true));
    el('incorrect-btn').addEventListener('click', () => gradeCurrent(false));
    el('next-btn').addEventListener('click', nextCard);
    el('quit-btn').addEventListener('click', endSession);
    toggleNotesBtn.addEventListener('click', () => {
      notesPanel.classList.toggle('hidden');
      updateNoteStatus('');
    });
    hideNotesBtn.addEventListener('click', () => {
      notesPanel.classList.add('hidden');
      updateNoteStatus('');
    });
    saveNotesBtn.addEventListener('click', () => saveCurrentNote(true));
    let noteSaveTimer = null;
    notesText.addEventListener('input', () => {
      clearTimeout(noteSaveTimer);
      noteSaveTimer = setTimeout(() => saveCurrentNote(true), 400);
    });
    notesText.addEventListener('blur', () => saveCurrentNote());

    exportDataBtn.addEventListener('click', exportData);
    importDataBtn.addEventListener('click', () => importDataInput.click());
    importDataInput.addEventListener('change', handleImportData);
    el('view-stats-btn').addEventListener('click', showStats);
    viewNotesBtn.addEventListener('click', showNotes);
    closeNotesBtn.addEventListener('click', () => notesScreen.classList.add('hidden'));
    el('close-stats-btn').addEventListener('click', () => {
      statsScreen.classList.add('hidden');
    });
    el('reset-stats-btn').addEventListener('click', () => {
      if (confirm('Reset all recorded stats?')) {
        stats = {};
        saveStats();
        renderStatsTable();
      }
    });

    function startSession() {
      const checked = Array.from(regionsContainer.querySelectorAll('input[type="checkbox"]:checked'));
      if (!checked.length) {
        alert('Select at least one technique to start.');
        return;
      }
      sessionDeck = buildWeightedDeck(checked.map(cb => cb.dataset.techName));
      currentIndex = 0;
      setupScreen.classList.add('hidden');
      statsScreen.classList.add('hidden');
      practiceScreen.classList.remove('hidden');
      loadCard();
    }

    function endSession() {
      practiceScreen.classList.add('hidden');
      setupScreen.classList.remove('hidden');
    }

    function findTechnique(name) {
      for (const region of TECHNIQUES) {
        const match = region.items.find(i => i.name === name);
        if (match) return { ...match, region: region.region };
      }
      return null;
    }

    function loadCard() {
      if (currentIndex >= sessionDeck.length) {
        promptText.textContent = 'Session complete';
        pageInfo.textContent = '';
        openPdfLink.href = '#';
        sessionProgress.textContent = `Done (${sessionDeck.length} cards)`;
        return;
      }
      const tech = sessionDeck[currentIndex];
      promptText.textContent = `Demonstrate: ${tech.name}`;
      pageInfo.textContent = `Manual page(s): ${tech.pages.join(', ')}`;
      const pageParam = tech.pages[0] || 1;
      const pdfUrl = buildPdfUrl(pageParam);
      openPdfLink.href = pdfUrl;
      manualVisible = false;
      renderedPages.classList.add('hidden'); // hide snapshots until requested
      showManualBtn.textContent = 'Show Manual Page';
      renderImages(tech.pages);
      loadCurrentNote(tech.name);
      notesPanel.classList.add('hidden');
      sessionProgress.textContent = `Card ${currentIndex + 1} / ${sessionDeck.length}`;
    }

    function gradeCurrent(correct) {
      if (currentIndex >= sessionDeck.length) return;
      const tech = sessionDeck[currentIndex];
      // autosave note on grade
      saveCurrentNote();
      const entry = stats[tech.name] || { correct: 0, incorrect: 0 };
      if (correct) entry.correct += 1; else entry.incorrect += 1;
      stats[tech.name] = entry;
      saveStats();
      nextCard();
    }

    function saveCurrentNote(showStatus) {
      if (currentIndex >= sessionDeck.length) return;
      const tech = sessionDeck[currentIndex];
      const text = (notesText.value || '').trim();
      if (!text) {
        if (showStatus) updateNoteStatus('Nothing to save');
        return;
      }
      const arr = notes[tech.name] || [];
      arr.push({ text, ts: Date.now() });
      notes[tech.name] = arr;
      saveNotes();
      renderNoteHistory(tech.name);
      if (showStatus) updateNoteStatus('Saved');
    }

    function loadCurrentNote(name) {
      notesText.value = '';
      renderNoteHistory(name);
      const hasNotes = (notes[name] && notes[name].length);
      updateNoteStatus(hasNotes ? 'Loaded' : '');
    }

    function nextCard() {
      if (currentIndex < sessionDeck.length) currentIndex += 1;
      loadCard();
    }

    function showStats() {
      renderStatsTable();
      statsScreen.classList.remove('hidden');
    }

    function renderStatsTable() {
      const wrapper = el('stats-table-wrapper');
      const allTechs = TECHNIQUES.flatMap(r => r.items.map(i => i.name));
      const rows = allTechs.map(name => {
        const s = stats[name] || { correct: 0, incorrect: 0 };
        const total = s.correct + s.incorrect;
        const pct = total ? Math.round((s.correct / total) * 100) : 0;
        return `<tr><td>${name}</td><td>${s.correct}</td><td>${s.incorrect}</td><td>${total}</td><td>${pct}%</td></tr>`;
      }).join('');
      wrapper.innerHTML = `
        <table class="stat-table">
          <thead>
            <tr><th>Technique</th><th>Correct</th><th>Incorrect</th><th>Total</th><th>Accuracy</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }

    function renderImages(pages) {
      const container = el('rendered-pages');
      container.innerHTML = '';
      if (!pages || !pages.length) {
        container.innerHTML = '<div class="muted">No pages listed.</div>';
        return;
      }
      pages.forEach(pageNum => {
        const img = document.createElement('img');
        img.className = 'rendered-img';
        img.src = `pages/page-${pageNum}.png`;
        img.alt = `Page ${pageNum}`;
        container.appendChild(img);
      });
      if (manualVisible) {
        container.classList.remove('hidden');
      }
    }

    function buildWeightedDeck(names) {
      const items = [];
      names.forEach(name => {
        const tech = findTechnique(name);
        if (!tech) return;
        const acc = getAccuracy(name);
        const attempts = (stats[name]?.correct || 0) + (stats[name]?.incorrect || 0);
        const freshnessBoost = attempts ? 0 : 0.5; // new items get extra weight
        const weight = Math.max(0.05, 1 - acc + freshnessBoost); // lower accuracy/new -> higher weight
        const score = Math.random() / weight;  // weighted random ordering
        items.push({ tech, score });
      });
      items.sort((a, b) => a.score - b.score);
      return items.map(i => i.tech);
    }

    function buildPdfUrl(pageParam) {
      return `${PDF_PATH}#page=${pageParam}&zoom=page-fit`;
    }

    // PDF file loading removed; we now rely on pre-rendered images.

    function exportData() {
      const data = { stats, notes };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'opp-practice-data.json';
      a.click();
      setTimeout(() => URL.revokeObjectURL(url), 500);
      setDataStatus('Exported data');
    }

    function handleImportData(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function() {
        try {
          const imported = JSON.parse(reader.result);
          stats = imported.stats || {};
          notes = imported.notes || {};
          saveStats();
          saveNotes();
          setDataStatus('Imported data');
        } catch (e) {
          console.warn('Import failed', e);
          setDataStatus('Import failed');
        }
      };
      reader.readAsText(file);
    }

    function showNotes() {
      renderNotesTable();
      notesScreen.classList.remove('hidden');
    }

    function renderNotesTable() {
      const wrapper = el('notes-table-wrapper');
      const rows = Object.entries(notes || {}).filter(([_, text]) => text && text.trim().length > 0);
      if (!rows.length) {
        wrapper.innerHTML = '<div class="muted">No notes saved yet.</div>';
        return;
      }
      const html = rows.map(([name, text]) => {
        const escaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<tr data-tech="${name}"><td>${name}</td><td>${escaped}</td></tr>`;
      }).join('');
      wrapper.innerHTML = `
        <table class="notes-table">
          <thead><tr><th>Technique</th><th>Note</th></tr></thead>
          <tbody>${html}</tbody>
        </table>
      `;
      wrapper.querySelectorAll('tr[data-tech]').forEach(row => {
        row.addEventListener('click', () => {
          const tech = row.getAttribute('data-tech');
          const text = notes[tech] || '';
          navigator.clipboard?.writeText(text).then(() => setDataStatus('Note copied')).catch(() => {});
        });
      });
    }

    function loadStats() {
      try {
        return JSON.parse(localStorage.getItem('opp-technique-stats') || '{}');
      } catch {
        return {};
      }
    }
    function saveStats() {
      localStorage.setItem('opp-technique-stats', JSON.stringify(stats));
    }
    function loadNotes() {
      try {
        return JSON.parse(localStorage.getItem('opp-technique-notes') || '{}');
      } catch {
        return {};
      }
    }
    function saveNotes() {
      try {
        localStorage.setItem('opp-technique-notes', JSON.stringify(notes));
      } catch (e) {
        console.warn('Unable to save notes', e);
      }
    }

    function updateNoteStatus(msg) {
      if (!noteStatus) return;
      noteStatus.textContent = msg || '';
    }

    function setDataStatus(msg) {
      if (!dataStatus) return;
      dataStatus.textContent = msg || '';
    }

    function normalizeNotes(raw) {
      const out = {};
      for (const [k, v] of Object.entries(raw || {})) {
        if (Array.isArray(v)) {
          out[k] = v;
        } else if (typeof v === 'string') {
          out[k] = v.trim() ? [{ text: v.trim(), ts: Date.now() }] : [];
        }
      }
      return out;
    }

    function renderNoteHistory(name) {
      if (!noteHistory) return;
      const arr = notes[name] || [];
      if (!arr.length) {
        noteHistory.innerHTML = '<div class="muted">No saved notes for this technique.</div>';
        return;
      }
      const items = arr.slice(-5).reverse().map(entry => {
        const date = new Date(entry.ts || Date.now()).toLocaleString();
        const escaped = (entry.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `<li><strong>${date}:</strong> ${escaped}</li>`;
      }).join('');
      noteHistory.innerHTML = `<h4>Recent notes</h4><ul>${items}</ul>`;
    }

    function getAccuracy(name) {
      const s = stats[name] || { correct: 0, incorrect: 0 };
      const total = s.correct + s.incorrect;
      return total ? (s.correct / total) : 0;
    }

    function accuracyColor(pct) {
      // pct is 0-100; map 0=red to 100=green
      const clamp = Math.max(0, Math.min(100, pct));
      const r = clamp < 50 ? 255 : Math.round(255 - (clamp - 50) * 5.1);
      const g = clamp < 50 ? Math.round(clamp * 5.1) : 255;
      return `rgb(${r},${g},120)`;
    }

    function isDisabled(name) {
      const lower = name.toLowerCase();
      return DISABLED_KEYWORDS.some(k => lower.includes(k));
    }
  </script>
</body>
</html>
